<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة التحكم</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Readex+Pro:wght@400;600;700&family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@25.12.2/build/css/intlTelInput.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css">
</head>
<body class="admin">

<header class="site-header">
  <div class="header-inner">
    <div class="brand">
      <span class="brand-mark"><i class="fa-solid fa-hospital"></i></span>
      <div>
        <h1>لوحة التحكم</h1>
        <p>إدارة المشافي والمستوصفات والصيدليات والعيادات والمخابر.</p>
      </div>
    </div>
    <div class="header-actions">
      <button id="adminMenuToggle" class="btn ghost admin-mobile-toggle" type="button" aria-label="القائمة">
        <i class="fa-solid fa-bars"></i>
      </button>
      <button id="adminThemeToggle" class="btn ghost admin-theme-toggle" type="button" aria-label="الوضع الداكن">
        <i class="fa-solid fa-moon"></i>
      </button>
      <a class="btn ghost" href="index.html">العودة للموقع</a>
    </div>
  </div>
</header>

<main class="container">
  <section id="loginPanel" class="login-panel">
    <div class="login-card">
      <h2>تسجيل الدخول</h2>
      <p class="muted">الرجاء إدخال بيانات الدخول للوصول إلى لوحة التحكم.</p>
      <div class="field">
        <label for="loginUser">اسم المستخدم</label>
        <input id="loginUser" placeholder="مثال: admin">
      </div>
      <div class="field">
        <label for="loginPass">كلمة المرور</label>
        <input id="loginPass" type="password" placeholder="••••••••">
      </div>
      <button id="loginBtn" class="btn primary" type="button">دخول</button>
    </div>
  </section>

  <section id="adminApp" hidden>
  <div id="adminSidebarBackdrop" class="admin-sidebar-backdrop" hidden></div>
  <div class="admin-layout">
  <aside class="admin-sidebar" id="adminSidebar">
    <button class="admin-nav-btn active" type="button" data-admin-view="dashboard">
      <i class="fa-solid fa-chart-line"></i>
      الإحصائيات
    </button>
    <button class="admin-nav-btn" type="button" id="navAddPlace">
      <i class="fa-solid fa-plus"></i>
      إضافة مكان طبي
    </button>
    <button class="admin-nav-btn" type="button" data-admin-view="places">
      <i class="fa-solid fa-table-list"></i>
      جدول الأماكن الطبية
    </button>
    <button class="admin-nav-btn" type="button" data-admin-view="users" data-super-only="true">
      <i class="fa-solid fa-users-gear"></i>
      إدارة المستخدمين
    </button>
    <button class="admin-nav-btn" type="button" data-admin-view="locations" data-super-only="true">
      <i class="fa-solid fa-map-location-dot"></i>
      إدارة المحافظات والمدن
    </button>
    <button class="admin-nav-btn" type="button" data-admin-view="specialties" data-super-only="true">
      <i class="fa-solid fa-stethoscope"></i>
      إدارة الاختصاصات
    </button>
    <button class="admin-nav-btn" type="button" data-admin-view="applications">
      <i class="fa-solid fa-file-signature"></i>
      طلبات إضافة/تعديل الأماكن
    </button>
    <button class="admin-nav-btn" type="button" data-admin-view="reports" data-super-only="true">
      <i class="fa-solid fa-triangle-exclamation"></i>
      بلاغات المستخدمين
    </button>
    <button class="admin-nav-btn" type="button" data-admin-view="logs">
      <i class="fa-solid fa-clock-rotate-left"></i>
      سجل النشاط
    </button>
    <div class="admin-sidebar-user">
      <div id="sidebarUserBadge" class="sidebar-user-badge" hidden></div>
      <button id="sidebarLogoutBtn" class="btn ghost" type="button" hidden>
        تسجيل الخروج
      </button>
    </div>
  </aside>
  <div class="admin-main">
  <section id="dashboardSection" class="dashboard" aria-label="ملخص الإدارة" data-view="dashboard">
    <div class="stats dashboard-stats">
      <div class="stat-card">
        <span>عدد الأماكن</span>
        <strong id="adminTotal">0</strong>
      </div>
      <div class="stat-card">
        <span>مناوبة اليوم</span>
        <strong id="adminOnDuty">0</strong>
      </div>
    </div>

    <div class="dashboard-grid">
      <article class="dashboard-card">
        <div class="dashboard-head">
          <h3>خريطة التوزع حسب المحافظات</h3>
          <p class="muted">كثافة الأماكن الطبية ضمن نطاق صلاحياتك.</p>
        </div>
        <div id="adminSyriaMap"></div>
      </article>

      <article class="dashboard-card">
        <div class="dashboard-head">
          <h3>أعلى المحافظات</h3>
          <p class="muted">ترتيب المحافظات حسب عدد الأماكن الطبية.</p>
        </div>
        <ul id="adminGovStats" class="gov-stats-list"></ul>
      </article>
    </div>
  </section>

  <div id="placesSection" data-view="places">
  <section class="admin-toolbar">
    <button class="btn primary" onclick="openModal()">
      <i class="fa-solid fa-plus"></i>
      إضافة مكان طبي
    </button>
    <div class="toolbar-actions">
      <button id="exportBtn" class="btn ghost" onclick="exportData()">تصدير البيانات</button>
      <button id="exportCsvBtn" class="btn ghost" onclick="exportCSV()">تصدير CSV</button>
      <button id="backupBtn" class="btn ghost" onclick="backupNow()">نسخة احتياطية</button>
      <button id="restoreBtn" class="btn ghost" onclick="restoreBackup()">استعادة آخر نسخة</button>
      <button id="importBtn" class="btn ghost" onclick="triggerImport()">استيراد بيانات</button>
      <button id="clearAllBtn" class="btn danger" onclick="clearAll()">حذف الكل</button>
    </div>
    <input id="importFile" type="file" accept="application/json" hidden>
  </section>

  <section class="controls" aria-label="فلاتر الإدارة">
    <div class="field">
      <label for="filterType">النوع</label>
      <select id="filterType">
        <option value="all">كل الأنواع</option>
        <option value="pharmacy">صيدلية</option>
        <option value="hospital">مشفى</option>
        <option value="dispensary">مستوصف</option>
        <option value="clinic">عيادة</option>
        <option value="lab">مخبر طبي</option>
      </select>
    </div>
    <div class="field">
      <label for="filterGov">المحافظة</label>
      <input id="filterGov" placeholder="ابحث عن محافظة">
    </div>
    <div class="field">
      <label for="filterCity">المدينة</label>
      <input id="filterCity" placeholder="ابحث عن مدينة">
    </div>
  </section>

  <section class="log-panel" aria-label="جدول الأماكن">
    <h3>جدول الأماكن الطبية</h3>
    <div class="table-actions">
      <button id="deleteSelected" class="btn danger" type="button">حذف المحدد</button>
    </div>
    <div class="table-wrap">
      <table id="adminTable">
        <thead>
          <tr>
            <th>الاسم</th>
            <th>النوع</th>
            <th>المحافظة</th>
            <th>المدينة</th>
            <th>إجراءات</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="pagination" id="adminPagination"></div>
    <div id="adminEmpty" class="empty-state" hidden>
      <i class="fa-regular fa-circle-xmark"></i>
      <p>لا توجد أماكن مطابقة للفلاتر.</p>
    </div>
  </section>
  </div>

  <section id="userManagement" class="log-panel" data-view="users" hidden>
    <h3>إدارة المستخدمين</h3>
    <div class="controls">
      <div class="field">
        <label for="userFilter">بحث المستخدمين</label>
        <input id="userFilter" placeholder="ابحث بالاسم أو الدور أو المحافظة">
      </div>
    </div>
    <div class="user-form">
      <div class="field">
        <label for="userName">اسم المستخدم</label>
        <input id="userName" placeholder="اسم المستخدم">
      </div>
      <div class="field">
        <label for="userPass">كلمة المرور</label>
        <input id="userPass" type="password" placeholder="كلمة المرور">
      </div>
      <div class="field">
        <label for="userPhone">رقم الهاتف</label>
        <input id="userPhone" data-intl-phone placeholder="رقم الهاتف">
      </div>
      <div class="field">
        <label for="userAddress">العنوان</label>
        <input id="userAddress" placeholder="العنوان">
      </div>
      <div class="field">
        <label for="userRole">الدور</label>
        <select id="userRole">
          <option value="super">مسؤول مميز</option>
          <option value="governorate">مسؤول محافظة</option>
          <option value="city">مسؤول مدينة</option>
          <option value="viewer">مشاهدة فقط</option>
        </select>
      </div>
      <div class="field">
        <label for="userGov">المحافظة</label>
        <select id="userGov"></select>
      </div>
      <div class="field">
        <label for="userCity">المدينة</label>
        <select id="userCity"></select>
      </div>
      <button id="addUserBtn" class="btn primary" type="button">إضافة مستخدم</button>
      <button id="updateUserBtn" class="btn ghost" type="button" hidden>تحديث بيانات</button>
    </div>
    <div id="usersList" class="user-list"></div>
  </section>

  <section id="locationManagement" class="log-panel" data-view="locations" hidden>
    <h3>إدارة المحافظات والمدن (للمسؤول المميز فقط)</h3>
    <div class="user-form">
      <div class="field">
        <label for="locGov">المحافظة</label>
        <select id="locGov"></select>
      </div>
      <div class="field">
        <label for="locCity">المدينة</label>
        <select id="locCity"></select>
      </div>
      <div class="field">
        <label for="newGov">إضافة محافظة</label>
        <input id="newGov" placeholder="اسم المحافظة">
      </div>
      <div class="field">
        <label for="newCity">إضافة مدينة</label>
        <input id="newCity" placeholder="اسم المدينة">
      </div>
    </div>
    <div class="loc-actions">
      <button id="addGovBtn" class="btn primary" type="button">إضافة محافظة</button>
      <button id="addCityBtn" class="btn primary" type="button">إضافة مدينة</button>
      <button id="removeGovBtn" class="btn danger" type="button">حذف محافظة</button>
      <button id="removeCityBtn" class="btn danger" type="button">حذف مدينة</button>
    </div>
  </section>

  <section id="specialtyManagement" class="log-panel" data-view="specialties" hidden>
    <h3>إدارة الاختصاصات (للمسؤول المميز فقط)</h3>
    <div class="user-form">
      <div class="field">
        <label for="specialtySelect">الاختصاصات الحالية</label>
        <select id="specialtySelect"></select>
      </div>
      <div class="field">
        <label for="newSpecialty">إضافة اختصاص</label>
        <input id="newSpecialty" placeholder="مثال: قلبية، أطفال، أشعة">
      </div>
    </div>
    <div class="loc-actions">
      <button id="addSpecialtyBtn" class="btn primary" type="button">إضافة اختصاص</button>
      <button id="removeSpecialtyBtn" class="btn danger" type="button">حذف اختصاص</button>
    </div>
  </section>

  <section id="activityPanel" class="log-panel" aria-label="سجل النشاطات" data-view="logs">
    <h3>سجل النشاط</h3>
    <ul id="adminLog" class="log-list"></ul>
    <div class="pagination" id="logPagination"></div>
  </section>

  <section id="reportsPanel" class="log-panel" data-view="reports" hidden>
    <h3>بلاغات المستخدمين</h3>
    <div class="controls">
      <div class="field">
        <label for="reportFilterStatus">حالة البلاغ</label>
        <select id="reportFilterStatus">
          <option value="all">الكل</option>
          <option value="open">مفتوح</option>
          <option value="in_progress">قيد المعالجة</option>
          <option value="resolved">مغلق</option>
        </select>
      </div>
    </div>
    <div class="table-wrap">
      <table id="reportsTable">
        <thead>
          <tr>
            <th>المكان</th>
            <th>الموقع</th>
            <th>نوع البلاغ</th>
            <th>الحالة</th>
            <th>ملاحظة</th>
            <th>التاريخ</th>
            <th>إجراءات</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="reportsEmpty" class="empty-state" hidden>
      <p>لا توجد بلاغات حالياً.</p>
    </div>
  </section>

  <section id="applicationsPanel" class="log-panel" data-view="applications" hidden>
    <h3>طلبات إضافة/تعديل الأماكن</h3>
    <div class="controls">
      <div class="field">
        <label for="applicationFilterStatus">الحالة</label>
        <select id="applicationFilterStatus">
          <option value="all">الكل</option>
          <option value="pending" selected>معلق</option>
          <option value="in_review">قيد المراجعة</option>
          <option value="approved">مقبول</option>
          <option value="rejected">مرفوض</option>
          <option value="needs_changes">يتطلب تعديل</option>
        </select>
      </div>
      <div class="field">
        <label for="applicationFilterType">النوع</label>
        <select id="applicationFilterType">
          <option value="all">الكل</option>
          <option value="create">إضافة</option>
          <option value="update">تعديل</option>
        </select>
      </div>
    </div>
    <div class="table-wrap">
      <table id="applicationsTable">
        <thead>
          <tr>
            <th>النوع</th>
            <th>المكان</th>
            <th>صاحب الطلب</th>
            <th>الحالة</th>
            <th>تاريخ الإرسال</th>
            <th>إجراءات</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="applicationsEmpty" class="empty-state" hidden>
      <p>لا توجد طلبات حالياً.</p>
    </div>
  </section>
  </div>
  </div>
  </section>
</main>

<div class="modal" id="placeModal" aria-hidden="true">
  <div class="modal-box modal-wide">
    <h3 id="modalTitle">إضافة مكان طبي</h3>
    <input type="hidden" id="editIndex">
    <div class="modal-form-shell">
    <section class="form-section">
      <h4 class="form-section-title">
        <i class="fa-solid fa-circle-info"></i>
        البيانات الأساسية
      </h4>
    <div class="form-grid">
      <div class="field">
        <label for="name">اسم المكان</label>
        <input id="name" placeholder="مثال: صيدلية الشفاء">
      </div>
      <div class="field">
        <label for="type">النوع</label>
        <select id="type">
          <option value="">اختر النوع</option>
          <option value="pharmacy">صيدلية</option>
          <option value="hospital">مشفى</option>
          <option value="dispensary">مستوصف</option>
          <option value="clinic">عيادة</option>
          <option value="lab">مخبر طبي</option>
        </select>
      </div>
      <div class="field" id="specialtyField">
        <label for="specialty">الاختصاص</label>
        <input id="specialty" type="hidden">
        <div class="multi-select" id="specialtyMulti">
          <div id="specialtyChips" class="multi-chips"></div>
          <input id="specialtySearch" placeholder="ابحث واختر اختصاص من القائمة">
        </div>
        <div id="specialtySuggestions" class="multi-suggestions" hidden></div>
      </div>
      <div class="field">
        <label for="phone">الهاتف</label>
        <input id="phone" data-intl-phone placeholder="مثال: 0999999999">
      </div>
      <div class="field">
        <label for="whatsapp">واتساب (اختياري)</label>
        <input id="whatsapp" data-intl-phone placeholder="مثال: 963999999999">
      </div>
      <div class="field">
        <label for="email">البريد الإلكتروني (اختياري)</label>
        <input id="email" placeholder="example@email.com">
      </div>
      <div class="field">
        <label for="governorate">المحافظة</label>
        <select id="governorate"></select>
      </div>
      <div class="field">
        <label for="city">المدينة</label>
        <select id="city"></select>
      </div>
      <div class="field">
        <label for="address">العنوان التفصيلي</label>
        <input id="address" placeholder="اسم الشارع أو المعلم القريب">
      </div>
      <div class="field">
        <label>ساعات العمل (اختياري)</label>
        <div class="time-range">
          <input id="hoursStart" type="time">
          <span>—</span>
          <input id="hoursEnd" type="time">
        </div>
        <label class="hours-24">
          <input id="hours24" type="checkbox">
          يعمل 24 ساعة
        </label>
        <input id="hours" type="hidden">
      </div>
      <div class="field span-2">
        <label>أيام العمل</label>
        <div class="workdays-grid">
          <label><input id="workdaysAll" type="checkbox" value="all"> كل الأيام</label>
          <label><input type="checkbox" name="workdays" value="الأحد"> الأحد</label>
          <label><input type="checkbox" name="workdays" value="الاثنين"> الاثنين</label>
          <label><input type="checkbox" name="workdays" value="الثلاثاء"> الثلاثاء</label>
          <label><input type="checkbox" name="workdays" value="الأربعاء"> الأربعاء</label>
          <label><input type="checkbox" name="workdays" value="الخميس"> الخميس</label>
          <label><input type="checkbox" name="workdays" value="الجمعة"> الجمعة</label>
          <label><input type="checkbox" name="workdays" value="السبت"> السبت</label>
        </div>
      </div>
      <div class="field">
        <label for="services">الخدمات (اختياري)</label>
        <input id="services" placeholder="مثال: قياس ضغط، تحاليل، إسعافات">
      </div>
      <div class="field">
        <label for="notes">ملاحظات (اختياري)</label>
        <input id="notes" placeholder="تفاصيل إضافية">
      </div>
      <div class="field">
        <label for="image">رابط صورة (اختياري)</label>
        <input id="image" placeholder="https://...">
      </div>
      <div class="field">
        <label for="imageFile">صورة من الجهاز (اختياري)</label>
        <input id="imageFile" type="file" accept="image/*" capture="environment">
      </div>
      <div id="imagePreview" class="image-preview">لا توجد صورة</div>
    </div>
    </section>

    <section class="form-section">
    <h4 class="form-section-title">
      <i class="fa-regular fa-calendar-days"></i>
      تواريخ المناوبة
    </h4>
    <div class="field">
      <label class="field-label">تواريخ المناوبة</label>
      <div class="inline-actions">
        <input id="dutyDatesPicker" readonly>
        <button id="clearDutyDates" class="btn ghost" type="button">مسح التواريخ</button>
      </div>
    </div>
    </section>

    <section class="form-section">
    <h4 class="form-section-title">
      <i class="fa-solid fa-map-location-dot"></i>
      الموقع على الخريطة
    </h4>
    <div class="map-inline">
      <input id="lat" type="number" step="0.000001" placeholder="خط العرض">
      <input id="lng" type="number" step="0.000001" placeholder="خط الطول">
    </div>
    <div id="selectMap"></div>
    </section>

    <div class="modal-actions">
      <button class="save" onclick="savePlace()">حفظ</button>
      <button class="cancel" onclick="closeModal()">إلغاء</button>
    </div>
    </div>
  </div>
</div>

<div class="modal" id="cropModal" aria-hidden="true">
  <div class="modal-box modal-wide crop-box">
    <h3>قص وتدوير الصورة</h3>
    <div class="crop-wrap">
      <img id="cropImage" alt="صورة القص">
    </div>
    <div class="crop-actions">
      <button id="rotateLeft" class="btn ghost" type="button">تدوير يسار</button>
      <button id="rotateRight" class="btn ghost" type="button">تدوير يمين</button>
      <button id="cropSave" class="btn primary" type="button">حفظ</button>
      <button id="cropCancel" class="btn ghost" type="button">إلغاء</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/intl-tel-input@25.12.2/build/js/intlTelInput.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.48.1/dist/umd/supabase.min.js"></script>
<script src="js/supabase.js"></script>
<script src="js/admin.js"></script>
</body>
</html>
